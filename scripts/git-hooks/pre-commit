#!/usr/bin/env bash
# Pre-commit hook: prüft die Struktur der Unreleased-Notizen.
# Installation:
#   cp scripts/git-hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -euo pipefail

echo "[pre-commit] Prüfe changelog-unreleased.md …"
if ! npm run --silent changelog:lint; then
  echo
  echo "[pre-commit] Fehler im Changelog erkannt. Commit abgebrochen."
  echo "[pre-commit] Bitte Datei korrigieren und erneut committen."
  exit 1
fi

# Ermittele gestagte Dateien, um gezielt Builds zu triggern
mapfile -t changed_files < <(git diff --cached --name-only --diff-filter=ACMRT)

if [ "${#changed_files[@]}" -eq 0 ]; then
  echo "[pre-commit] Keine gestagten Dateien – keine Builds notwendig."
  exit 0
fi

needs_backend=0
needs_dashboard=0
needs_bsky_client=0
needs_shared_ui=0
needs_media_pickers=0
needs_root_lint=0

for file in "${changed_files[@]}"; do
  case "$file" in
    backend/*)
      needs_backend=1
      ;;
    dashboard/*)
      needs_dashboard=1
      ;;
    bsky-client/*)
      needs_bsky_client=1
      ;;
    packages/shared-ui/*)
      needs_shared_ui=1
      ;;
    packages/media-pickers/*)
      needs_media_pickers=1
      ;;
    package.json|package-lock.json|tsconfig*.json|vitest.config.mjs|eslint.config.mjs|scripts/build-all.js|scripts/git-hooks/pre-commit)
      # Globale Dateien beeinflussen mehrere Workspaces -> alles bauen
      needs_backend=1
      needs_dashboard=1
      needs_bsky_client=1
      needs_shared_ui=1
      needs_media_pickers=1
      needs_root_lint=1
      ;;
    *.js|*.jsx|*.ts|*.tsx|*.mjs)
      needs_root_lint=1
      ;;
  esac
done

run_step() {
  local label="$1"
  shift
  echo "[pre-commit] Baue ${label} …"
  if ! "$@"; then
    echo "[pre-commit] ${label} fehlgeschlagen. Commit abgebrochen."
    exit 1
  fi
}

if [ "$needs_backend" -eq 1 ]; then
  run_step "Lint Backend" npm run lint --workspace backend
  run_step "Backend" npm run --silent build:backend
fi

if [ "$needs_bsky_client" -eq 1 ]; then
  run_step "Lint Bsky-Client" npm run lint --workspace bsky-client
  run_step "Bsky-Client" npm run build:bsky-client
fi

if [ "$needs_dashboard" -eq 1 ]; then
  run_step "Lint Dashboard" npm run lint --workspace dashboard
  run_step "Dashboard" npm run build:frontend
fi

if [ "$needs_shared_ui" -eq 1 ]; then
  run_step "Lint Shared UI" npm run lint --workspace @bsky-kampagnen-bot/shared-ui
  run_step "Shared UI" npm run build --workspace packages/shared-ui
fi

if [ "$needs_media_pickers" -eq 1 ]; then
  run_step "Lint Media-Pickers" npm run lint --workspace @kampagnen-bot/media-pickers
  run_step "Media-Pickers" npm run build --workspace packages/media-pickers
fi

if [ "$needs_root_lint" -eq 1 ]; then
  run_step "Lint Repo" npm run lint
fi

echo "[pre-commit] Alle erforderlichen Builds erfolgreich."
exit 0
