name: ThreadWriter Tauri Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Git tag to build and release (e.g. v1.2.0)
        required: false
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libssl-dev \
            librsvg2-dev \
            patchelf \
            build-essential
      - name: Install macOS dependencies
        if: matrix.os == 'macos-latest'
        run: |
          brew update
          # Für Standard-Tauri-Builds sind i. d. R. keine zusätzlichen Pakete nötig
          echo "macOS deps installed"
      - name: Install Windows dependencies
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # Windows-Laufzeit bringt die benötigten Build-Tools bereits mit
          Write-Host "Windows deps ready"

      - name: Install root deps
        run: npm ci

      - name: Install threadwriter deps
        run: |
          cd threadwriter
          npm ci

      - name: Build and release with Tauri
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: threadwriter
          tagName: ${{ inputs.tag || github.ref_name }}
          releaseName: ${{ inputs.tag || github.ref_name }}
          releaseBody: |
            ThreadWriter Desktop build for ${{ matrix.os }}.

            Siehe CHANGELOG für Details.
          releaseDraft: true
          prerelease: false
          includeDebug: false
          # Optional Codesigning (füllt die Action automatisch, wenn Secrets gesetzt sind)
          windowsCertificate: ${{ runner.temp }}/windows_cert.pfx
          windowsCertificatePassword: ${{ secrets.WIN_CERT_PASSWORD }}
          appleId: ${{ secrets.APPLE_ID }}
          applePassword: ${{ secrets.APPLE_PASSWORD }}
          appleTeamId: ${{ secrets.APPLE_TEAM_ID }}

      - name: Prepare Windows certificate (optional)
        if: matrix.os == 'windows-latest' && secrets.WIN_CERT_PFX != ''
        shell: pwsh
        run: |
          $bytes = [Convert]::FromBase64String('${{ secrets.WIN_CERT_PFX }}')
          [IO.File]::WriteAllBytes("$env:RUNNER_TEMP\windows_cert.pfx", $bytes)
